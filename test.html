<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fabled Familiars</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'MedievalSharp', cursive;
  color: #f0e6d2;
  min-height: 100vh;
  background: radial-gradient(circle, #4a2e5a 0%, #2a0e3a 70%);
}

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
h1, h2, h3 { color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

.header {
  background: rgba(42,14,58,0.9);
  border: 4px solid #ffd700;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
  position: relative;
}

.avatar-box {
  position: absolute;
  left: 20px;
  top: 20px;
  width: 80px;
  height: 80px;
  border: 3px solid #ffd700;
  border-radius: 50%;
  overflow: hidden;
  background: rgba(0,0,0,0.5);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2em;
}

.avatar-box:hover { box-shadow: 0 0 20px #ffd700; }
.avatar-box img { width: 100%; height: 100%; object-fit: cover; }

.nav {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.nav-btn, .btn {
  padding: 10px 20px;
  background: linear-gradient(to bottom, #4a2e5a, #2a0e3a);
  color: #ffd700;
  border: 2px solid #ffd700;
  cursor: pointer;
  font-family: 'MedievalSharp', cursive;
  font-size: 16px;
  font-weight: bold;
  transition: 0.3s;
}

.nav-btn:hover, .btn:hover { box-shadow: 0 0 15px #fff; color: #fff; }
.nav-btn.active { background: #ffd700; color: #2a0e3a; }
.btn:disabled { background: #333; color: #777; cursor: not-allowed; }

.status-bar {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.status-item {
  background: rgba(255,215,0,0.15);
  padding: 8px 15px;
  border: 1px solid rgba(255,215,0,0.5);
  font-weight: bold;
}

.section {
  background: rgba(42,14,58,0.85);
  padding: 25px;
  margin-bottom: 20px;
  border: 4px solid #ffd700;
  display: none;
}

.section.active { display: block; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.card {
  background: rgba(42,14,58,0.95);
  padding: 20px;
  text-align: center;
  border: 2px solid #ffd700;
  transition: 0.3s;
  position: relative;
}

.card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.7); }

.card-image {
  width: 100px;
  height: 100px;
  margin: 0 auto 15px;
  background: rgba(0,0,0,0.3);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 50px;
  border: 2px solid #ffd700;
  overflow: hidden;
}

.card-image img { width: 100%; height: 100%; object-fit: cover; }

.personality-tag {
  display: inline-block;
  background: rgba(155,89,182,0.3);
  border: 1px solid #9b59b6;
  padding: 2px 8px;
  margin: 2px;
  border-radius: 3px;
  font-size: 0.75em;
}

.achievement-badge {
  background: rgba(0,0,0,0.5);
  border: 2px solid #ffd700;
  padding: 15px;
  margin: 10px;
  border-radius: 5px;
  display: inline-block;
}

.achievement-badge.unlocked {
  border-color: #2ecc71;
  background: rgba(46,204,113,0.2);
}

.event-banner {
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  border: 3px solid #ffd700;
  padding: 15px;
  margin-bottom: 20px;
  text-align: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 10px #e74c3c; }
  50% { box-shadow: 0 0 25px #e74c3c; }
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(42,14,58,0.98);
  color: #ffd700;
  padding: 15px 25px;
  border: 2px solid #ffd700;
  opacity: 0;
  transition: 0.3s;
  z-index: 10000;
  max-width: 300px;
}

.notification.show { opacity: 1; }
.hidden { display: none !important; }

.battle-arena {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  border: 2px solid #ffd700;
  background: rgba(0,0,0,0.3);
  margin-bottom: 20px;
}

.battle-familiar { text-align: center; position: relative; }

.health-bar {
  width: 100%;
  height: 15px;
  background: #333;
  margin-top: 10px;
  border: 1px solid #ffd700;
}

.health-bar-fill {
  height: 100%;
  background: #c0392b;
  transition: width 0.5s;
}

.battle-log {
  background: rgba(0,0,0,0.2);
  border: 1px solid #ffd700;
  padding: 10px;
  margin-bottom: 20px;
  height: 100px;
  overflow-y: scroll;
  font-size: 0.9em;
}

.battle-familiar.hit { animation: hitFlash 0.35s; }
@keyframes hitFlash {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.7); }
}

.battle-familiar.shake { animation: shake 0.5s; }
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

.loot-popup, .modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(42,14,58,0.98);
  border: 3px solid #ffd700;
  padding: 30px;
  border-radius: 10px;
  z-index: 9999;
  text-align: center;
  min-width: 300px;
  max-height: 80vh;
  overflow-y: auto;
}

.loot-item {
  background: rgba(0,0,0,0.3);
  padding: 10px;
  margin: 5px 0;
  border: 1px solid #ffd700;
}

.selected { border-color: #fff !important; box-shadow: 0 0 30px #fff !important; }

.leaderboard-entry {
  background: rgba(0,0,0,0.3);
  padding: 10px;
  margin: 5px 0;
  border-left: 3px solid #ffd700;
  display: flex;
  justify-content: space-between;
}

.leaderboard-entry.you {
  border-left-color: #2ecc71;
  background: rgba(46,204,113,0.2);
}

@media (max-width: 768px) {
  .grid { grid-template-columns: 1fr; }
  .avatar-box { position: relative; left: auto; top: auto; margin: 0 auto 15px; }
}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="avatar-box" id="avatarBox" onclick="openAvatarModal()">
        <span id="avatarDisplay">üë§</span>
      </div>
      
      <h1>Fabled Familiars</h1>
      <div id="serverTime" style="font-size:1.5em;color:#ffd700;margin:10px 0;"></div>
      
      <div class="nav" id="mainNav" style="display:none;">
        <button class="nav-btn" onclick="goToSection('home')">Home</button>
        <button class="nav-btn" onclick="goToSection('familiars')">Familiars</button>
        <button class="nav-btn" onclick="goToSection('battle')">Battle</button>
        <button class="nav-btn" onclick="goToSection('inventory')">Materials</button>
        <button class="nav-btn" onclick="goToSection('crafting')">Crafting</button>
        <button class="nav-btn" onclick="goToSection('shop')">Shop</button>
        <button class="nav-btn" onclick="goToSection('achievements')">Achievements</button>
        <button class="nav-btn" onclick="goToSection('leaderboard')">Leaderboard</button>
      </div>

      <div class="status-bar" id="statusBar" style="display:none;">
        <div class="status-item">Coins: <span id="coinCount">0</span></div>
        <div class="status-item">Dust: <span id="dustCount">0</span></div>
        <div class="status-item">Lv.<span id="playerLevel">1</span></div>
        <div class="status-item"><span id="playerClass">None</span></div>
        <div class="status-item">XP: <span id="playerXP">0</span>/100</div>
        <button class="nav-btn" onclick="clearSave()">New Game</button>
      </div>
    </div>

    <div id="eventBanner" class="event-banner hidden">
      <h3 id="eventTitle"></h3>
      <p id="eventDesc"></p>
    </div>

    <div class="section active" id="intro">
      <div style="text-align:center;max-width:800px;margin:0 auto;">
        <h2>Welcome to Aethelburg!</h2>
        <p style="margin:20px 0;">Choose your path, Keeper.</p>
        
        <h3>Choose Your Class</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;">
          <div class="card" onclick="pickClass('Wizard')">
            <div style="font-size:3em;">üßô</div>
            <h3>Wizard</h3>
            <p>+50% XP</p>
          </div>
          <div class="card" onclick="pickClass('Knight')">
            <div style="font-size:3em;">‚öîÔ∏è</div>
            <h3>Knight</h3>
            <p>+20% HP/DEF</p>
          </div>
          <div class="card" onclick="pickClass('Elf')">
            <div style="font-size:3em;">üèπ</div>
            <h3>Elf</h3>
            <p>+15% SPD/ATK</p>
          </div>
        </div>

        <h3>Choose Your Faction</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;">
          <div class="card" onclick="pickFaction('Mages Circle')">
            <h3>Mage's Circle</h3>
            <p>+10% crafting</p>
          </div>
          <div class="card" onclick="pickFaction('Knights Order')">
            <h3>Knight's Order</h3>
            <p>+10% rewards</p>
          </div>
          <div class="card" onclick="pickFaction('Rangers Guild')">
            <h3>Ranger's Guild</h3>
            <p>Rare spawns</p>
          </div>
        </div>

        <h3>Choose Your Starter</h3>
        <div id="starterGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;"></div>

        <button class="btn" id="beginBtn" onclick="startGame()" disabled>Begin Adventure!</button>
      </div>
    </div>

    <div class="section" id="home">
      <h2>Welcome Home!</h2>
      <p id="welcomeMsg">Your adventure continues...</p>
      <div class="grid">
        <div class="card" onclick="claimDaily()">
          <h3>Daily Bonus</h3>
          <p>+50 coins, +5 dust</p>
          <button class="btn">Claim</button>
        </div>
        <div class="card">
          <h3>Your Journey</h3>
          <p id="journeyStats">Loading...</p>
        </div>
        <div class="card" onclick="goToSection('battle')">
          <h3>Quick Battle</h3>
          <button class="btn">Fight!</button>
        </div>
        <div class="card" onclick="goToSection('achievements')">
          <h3>Achievements</h3>
          <p id="achievementProgress">0/10 unlocked</p>
          <button class="btn">View</button>
        </div>
      </div>
    </div>

    <div class="section" id="familiars">
      <h2>Your Familiars</h2>
      <div class="grid" id="familiarGrid"></div>
    </div>

    <div class="section" id="inventory">
      <h2>Materials</h2>
      <div class="grid" id="inventoryGrid"></div>
    </div>

    <div class="section" id="crafting">
      <h2>Crafting</h2>
      <div class="grid" id="craftingGrid"></div>
    </div>

    <div class="section" id="shop">
      <h2>Market</h2>
      <div class="grid" id="shopGrid"></div>
    </div>

    <div class="section" id="achievements">
      <h2>Achievements</h2>
      <div id="achievementGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin-top:20px;"></div>
    </div>

    <div class="section" id="leaderboard">
      <h2>Leaderboard</h2>
      <p style="margin-bottom:20px;">Top Keepers of Aethelburg</p>
      <div id="leaderboardList"></div>
    </div>

    <div class="section" id="battle">
      <h2>Battle Arena</h2>
      <div id="familiarSelect">
        <h3>Select Champion</h3>
        <div class="grid" id="battleSelectGrid"></div>
      </div>

      <div id="battleScreen" style="display:none;">
        <div class="battle-arena">
          <div class="battle-familiar" id="playerFam"></div>
          <div class="battle-familiar" id="enemyFam"></div>
        </div>
        <div class="battle-log" id="battleLog"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:15px;">
          <button class="btn" onclick="doAttack()">Attack</button>
          <button class="btn" onclick="doDefend()">Defend</button>
          <button class="btn" onclick="doRetreat()">Retreat</button>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notif"></div>
  
  <div class="loot-popup hidden" id="lootPopup">
    <h2>Victory!</h2>
    <div id="lootList"></div>
    <button class="btn" onclick="closeLoot()">Continue</button>
  </div>

  <div class="modal hidden" id="avatarModal">
    <h2>Choose Avatar</h2>
    <input type="text" id="avatarURL" placeholder="Image URL" style="width:100%;padding:10px;margin:15px 0;background:rgba(0,0,0,0.3);color:#f0e6d2;border:2px solid #ffd700;">
    <div style="display:flex;gap:10px;margin:15px 0;">
      <button class="btn" onclick="saveAvatarURL()">Save</button>
      <button class="btn" onclick="closeAvatarModal()">Cancel</button>
    </div>
    <p>Or pick emoji:</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="btn" onclick="saveAvatarEmoji('üßô')">üßô</button>
      <button class="btn" onclick="saveAvatarEmoji('‚öîÔ∏è')">‚öîÔ∏è</button>
      <button class="btn" onclick="saveAvatarEmoji('üèπ')">üèπ</button>
      <button class="btn" onclick="saveAvatarEmoji('üëë')">üëë</button>
      <button class="btn" onclick="saveAvatarEmoji('üêâ')">üêâ</button>
    </div>
  </div>

  <div class="modal hidden" id="renameModal">
    <h2>Rename Familiar</h2>
    <input type="text" id="renameInput" placeholder="New name" style="width:100%;padding:10px;margin:15px 0;background:rgba(0,0,0,0.3);color:#f0e6d2;border:2px solid #ffd700;" maxlength="20">
    <div style="display:flex;gap:10px;">
      <button class="btn" onclick="saveRename()">Save</button>
      <button class="btn" onclick="closeRenameModal()">Cancel</button>
    </div>
  </div>

  <div class="modal hidden" id="evolutionModal">
    <h2>Evolution!</h2>
    <p id="evolutionText"></p>
    <div id="evolutionDisplay" style="margin:20px 0;"></div>
    <button class="btn" onclick="closeEvolutionModal()">Amazing!</button>
  </div>

  <script>
const game = {
  init: false,
  player: { class: null, faction: null, avatar: 'üë§', name: 'Keeper' },
  coins: 0,
  dust: 0,
  level: 1,
  xp: 0,
  wins: 0,
  familiars: [],
  inventory: {},
  lastDaily: null,
  achievements: [],
  highestFamiliarLevel: 0,
  totalMaterialsCollected: 0
};

let sel = { class: null, faction: null, starter: null };
let battle = { player: null, enemy: null, turn: 'player' };
let renameTarget = null;
let currentEvent = null;

const personalities = ['Brave', 'Lazy', 'Hungry', 'Playful', 'Serious', 'Shy', 'Bold'];

const starters = [
  { species: 'grumblenook', name: 'Grumblenook', hp: 60, attack: 12, defense: 6, speed: 25, image: 'img/familiars/cute-deserrt-thing.jpg', evolves: true, evolvesAt: 10, evolvesInto: 'Greater Grumblenook' },
  { species: 'dragon', name: 'Silver Dragon', hp: 120, attack: 25, defense: 15, speed: 10, image: 'img/familiars/dragon.png', evolves: true, evolvesAt: 15, evolvesInto: 'Ancient Dragon' },
  { species: 'hippogriff', name: 'Hippogriff', hp: 110, attack: 22, defense: 14, speed: 13, image: 'img/familiars/griffin.jpg', evolves: true, evolvesAt: 12, evolvesInto: 'Royal Hippogriff' }
];

const enemies = [
  { name: 'Goblin', hp: 50, attack: 10, defense: 5, level: 3, image: 'img/enemies/goblin.png' },
  { name: 'Slime', hp: 40, attack: 8, defense: 8, level: 2, image: 'img/enemies/slime.png' },
  { name: 'Orc Warrior', hp: 90, attack: 18, defense: 12, level: 6, image: 'img/enemies/orc.png' },
  { name: 'Shadow Beast', hp: 120, attack: 22, defense: 15, level: 8, image: 'img/enemies/black-cat.jpg' }
];

const loot = [
  {item: 'Iron Ore', chance: 0.6, qty: [1,3]},
  {item: 'Magic Dust', chance: 0.5, qty: [1,2]},
  {item: 'Leather', chance: 0.5, qty: [1,2]},
  {item: 'Rare Gem', chance: 0.15, qty: [1,1]}
];

const recipes = [
  { id: 'armor', name: 'Basic Armor', mats: {'Iron Ore':3, 'Leather':2}, bonus: {stat:'defense', val:5} },
  { id: 'weapon', name: 'Basic Weapon', mats: {'Iron Ore':2}, bonus: {stat:'attack', val:5} },
  { id: 'advanced_armor', name: 'Steel Armor', mats: {'Iron Ore':5, 'Rare Gem':1}, bonus: {stat:'defense', val:10} },
  { id: 'summon', name: 'Summon Familiar', mats: {'Magic Dust':5, 'Rare Gem':2}, type: 'familiar' }
];

const achievements = [
  {id: 'first_win', name: 'First Victory', desc: 'Win your first battle', check: () => game.wins >= 1, icon: '‚öîÔ∏è'},
  {id: 'five_wins', name: 'Warrior', desc: 'Win 5 battles', check: () => game.wins >= 5, icon: 'üó°Ô∏è'},
  {id: 'ten_wins', name: 'Champion', desc: 'Win 10 battles', check: () => game.wins >= 10, icon: 'üèÜ'},
  {id: 'first_craft', name: 'Craftsman', desc: 'Craft your first item', check: () => Object.keys(game.inventory).length >= 3, icon: '‚öíÔ∏è'},
  {id: 'three_familiars', name: 'Growing Team', desc: 'Own 3 familiars', check: () => game.familiars.length >= 3, icon: 'üë•'},
  {id: 'level_5', name: 'Experienced', desc: 'Reach level 5', check: () => game.level >= 5, icon: '‚≠ê'},
  {id: 'level_10', name: 'Master Keeper', desc: 'Reach level 10', check: () => game.level >= 10, icon: 'üåü'},
  {id: 'evolution', name: 'Evolutionist', desc: 'Evolve a familiar', check: () => game.familiars.some(f => f.evolved), icon: '‚ú®'},
  {id: 'collector', name: 'Material Hoarder', desc: 'Collect 100 materials', check: () => game.totalMaterialsCollected >= 100, icon: 'üì¶'},
  {id: 'rich', name: 'Wealthy', desc: 'Have 500 coins', check: () => game.coins >= 500, icon: 'üí∞'}
];

const events = [
  {name: 'Lucky Hour', desc: '2x drop rates for 5 minutes!', duration: 300000, effect: 'double_drops'},
  {name: 'Rare Spawn', desc: 'Legendary enemies appearing!', duration: 600000, effect: 'rare_enemies'},
  {name: 'Merchant Visit', desc: '50% off all shop items!', duration: 300000, effect: 'shop_sale'}
];

function triggerRandomEvent() {
  if (Math.random() < 0.1 && !currentEvent) {
    const event = events[Math.floor(Math.random() * events.length)];
    currentEvent = event;
    showEvent(event);
    setTimeout(() => {
      currentEvent = null;
      hideEvent();
    }, event.duration);
  }
}

function showEvent(event) {
  const banner = document.getElementById('eventBanner');
  document.getElementById('eventTitle').textContent = event.name + '!';
  document.getElementById('eventDesc').textContent = event.desc;
  banner.classList.remove('hidden');
}

function hideEvent() {
  document.getElementById('eventBanner').classList.add('hidden');
}

function checkAchievements() {
  let newUnlocks = 0;
  achievements.forEach(ach => {
    if (!game.achievements.includes(ach.id) && ach.check()) {
      game.achievements.push(ach.id);
      notify('Achievement Unlocked: ' + ach.name + '!');
      newUnlocks++;
    }
  });
  if (newUnlocks > 0) save();
}

function renderAchievements() {
  const grid = document.getElementById('achievementGrid');
  grid.innerHTML = '';
  
  achievements.forEach(ach => {
    const unlocked = game.achievements.includes(ach.id);
    const badge = document.createElement('div');
    badge.className = 'achievement-badge' + (unlocked ? ' unlocked' : '');
    badge.innerHTML = `
      <div style="font-size:2.5em;">${ach.icon}</div>
      <h3>${ach.name}</h3>
      <p style="font-size:0.9em;margin-top:5px;">${ach.desc}</p>
      ${unlocked ? '<p style="color:#2ecc71;margin-top:10px;">‚úì Unlocked</p>' : '<p style="opacity:0.5;margin-top:10px;">üîí Locked</p>'}
    `;
    grid.appendChild(badge);
  });
  
  document.getElementById('achievementProgress').textContent = game.achievements.length + '/' + achievements.length + ' unlocked';
}

function generateLeaderboard() {
  const scores = [
    {name: 'DragonMaster', level: 15, wins: 45},
    {name: 'ShadowKeeper', level: 12, wins: 38},
    {name: 'MysticWarrior', level: 11, wins: 35},
    {name: game.player.name, level: game.level, wins: game.wins, you: true},
    {name: 'IronFist', level: 9, wins: 28},
    {name: 'SwiftBlade', level: 8, wins: 24}
  ];
  
  scores.sort((a,b) => b.wins - a.wins);
  
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  
  scores.forEach((s, i) => {
    const entry = document.createElement('div');
    entry.className = 'leaderboard-entry' + (s.you ? ' you' : '');
    entry.innerHTML = `
      <span><strong>#${i+1}</strong> ${s.name}</span>
      <span>Level ${s.level} ‚Ä¢ ${s.wins} wins</span>
    `;
    list.appendChild(entry);
  });
}

function openRenameModal(id) {
  renameTarget = id;
  document.getElementById('renameModal').classList.remove('hidden');
  document.getElementById('renameInput').value = '';
  document.getElementById('renameInput').focus();
}

function closeRenameModal() {
  document.getElementById('renameModal').classList.add('hidden');
  renameTarget = null;
}

function saveRename() {
  const newName = document.getElementById('renameInput').value.trim();
  if (!newName || !renameTarget) return;
  
  const fam = game.familiars.find(f => f.id === renameTarget);
  if (fam) {
    fam.name = newName;
    notify('Renamed to ' + newName + '!');
    renderFamiliars();
    save();
  }
  closeRenameModal();
}

function checkEvolution(fam) {
  if (!fam.evolves || fam.evolved) return;
  if (fam.level >= fam.evolvesAt) {
    evolveFamiliar(fam);
  }
}

function evolveFamiliar(fam) {
  const oldName = fam.name;
  fam.name = fam.evolvesInto;
  fam.evolved = true;
  fam.maxHp = Math.floor(fam.maxHp * 1.5);
  fam.currentHp = fam.maxHp;
  fam.attack = Math.floor(fam.attack * 1.3);
  fam.defense = Math.floor(fam.defense * 1.3);
  fam.speed = Math.floor(fam.speed * 1.2);
  
  showEvolutionModal(oldName, fam);
  checkAchievements();
}

function showEvolutionModal(oldName, fam) {
  const modal = document.getElementById('evolutionModal');
  document.getElementById('evolutionText').textContent = `${oldName} evolved into ${fam.name}!`;
  const display = document.getElementById('evolutionDisplay');
  const img = fam.image ? `<img src="${fam.image}" style="width:150px;height:150px;border-radius:50%;" onerror="this.src='img/familiars/familiars.png'">` : '';
  display.innerHTML = `
    ${img}
    <h3>${fam.name}</h3>
    <p>HP: ${fam.maxHp} | ATK: ${fam.attack} | DEF: ${fam.defense}</p>
  `;
  modal.classList.remove('hidden');
}

function closeEvolutionModal() {
  document.getElementById('evolutionModal').classList.add('hidden');
}

function openAvatarModal() {
  document.getElementById('avatarModal').classList.remove('hidden');
}

function closeAvatarModal() {
  document.getElementById('avatarModal').classList.add('hidden');
}

function saveAvatarEmoji(emoji) {
  game.player.avatar = emoji;
  document.getElementById('avatarDisplay').innerHTML = emoji;
  closeAvatarModal();
  save();
}

function saveAvatarURL() {
  const url = document.getElementById('avatarURL').value.trim();
  if (!url) { notify('Enter URL'); return; }
  game.player.avatar = url;
  document.getElementById('avatarDisplay').innerHTML = `<img src="${url}" onerror="this.innerHTML='üë§'">`;
  closeAvatarModal();
  save();
  notify('Avatar updated!');
}

function updateAvatar() {
  const disp = document.getElementById('avatarDisplay');
  const av = game.player.avatar || 'üë§';
  if (av.startsWith('http') || av.startsWith('data:')) {
    disp.innerHTML = `<img src="${av}" onerror="this.innerHTML='üë§'">`;
  } else {
    disp.innerHTML = av;
  }
}

function goToSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  
  if (name === 'battle') renderBattleSelect();
  if (name === 'familiars') renderFamiliars();
  if (name === 'inventory') renderInventory();
  if (name === 'crafting') renderCrafting();
  if (name === 'shop') renderShop();
  if (name === 'achievements') renderAchievements();
  if (name === 'leaderboard') generateLeaderboard();
}

function pickClass(c) {
  sel.class = c;
  document.querySelectorAll('.card').forEach(card => {
    if (card.textContent.includes(c)) card.classList.add('selected');
  });
  checkReady();
}

function pickFaction(f) {
  sel.faction = f;
  document.querySelectorAll('.card').forEach(card => {
    if (card.textContent.includes(f)) card.classList.add('selected');
  });
  checkReady();
}

function pickStarter(s, el) {
  sel.starter = s;
  document.querySelectorAll('#starterGrid .card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  checkReady();
}

function checkReady() {
  document.getElementById('beginBtn').disabled = !(sel.class && sel.faction && sel.starter);
}

function renderStarters() {
  const grid = document.getElementById('starterGrid');
  grid.innerHTML = '';
  starters.forEach(s => {
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => pickStarter(s, card);
    const img = s.image ? `<img src="${s.image}" style="width:80px;height:80px;border-radius:50%;" onerror="this.src='img/familiars/familiars.png'">` : '';
    card.innerHTML = `${img}<h3>${s.name}</h3><p>HP:${s.hp} ATK:${s.attack}</p><p style="font-size:0.8em;color:#9b59b6;">Evolves at Lv.${s.evolvesAt}</p>`;
    grid.appendChild(card);
  });
}

function startGame() {
  if (!sel.class || !sel.faction || !sel.starter) return;
  
  game.player.class = sel.class;
  game.player.faction = sel.faction;
  game.coins = 100;
  game.dust = 10;
  game.init = true;
  
  const fam = {
    id: Date.now(),
    ...sel.starter,
    level: 1,
    xp: 0,
    maxHp: sel.starter.hp,
    currentHp: sel.starter.hp,
    rarity: 'common',
    personality: personalities[Math.floor(Math.random() * personalities.length)]
  };
  game.familiars.push(fam);
  
  document.getElementById('mainNav').style.display = 'flex';
  document.getElementById('statusBar').style.display = 'flex';
  
  save();
  updateUI();
  updateAvatar();
  goToSection('home');
  notify('Welcome, ' + sel.class + '!');
  
  setInterval(triggerRandomEvent, 120000);
}

function renderFamiliars() {
  const grid = document.getElementById('familiarGrid');
  grid.innerHTML = '';
  
  if (game.familiars.length === 0) {
    grid.innerHTML = '<p>No familiars yet.</p>';
    return;
  }
  
  game.familiars.forEach(f => {
    const card = document.createElement('div');
    card.className = 'card';
    const img = f.image ? `<img src="${f.image}" onerror="this.src='img/familiars/familiars.png'">` : `<div>${f.species[0].toUpperCase()}</div>`;
    card.innerHTML = `
      <div class="card-image">${img}</div>
      <h3>${f.name} ${f.evolved ? '‚ú®' : ''}</h3>
      <span class="personality-tag">${f.personality}</span>
      <p>Lv.${f.level} ${f.rarity}</p>
      <p>HP: ${f.currentHp}/${f.maxHp}</p>
      <p>ATK:${f.attack} DEF:${f.defense} SPD:${f.speed}</p>
      ${f.evolves && !f.evolved ? `<p style="font-size:0.75em;color:#9b59b6;">Evolves at Lv.${f.evolvesAt}</p>` : ''}
      <div style="display:flex;gap:5px;margin-top:10px;">
        <button class="btn" onclick="healFam(${f.id})" ${f.currentHp >= f.maxHp ? 'disabled' : ''}>Heal (20)</button>
        <button class="btn" onclick="openRenameModal(${f.id})">Rename</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

function healFam(id) {
  const f = game.familiars.find(x => x.id === id);
  if (!f || game.coins < 20) { notify('Not enough coins!'); return; }
  game.coins -= 20;
  f.currentHp = f.maxHp;
  notify(f.name + ' healed!');
  updateUI();
  renderFamiliars();
  save();
}

function renderBattleSelect() {
  const grid = document.getElementById('battleSelectGrid');
  grid.innerHTML = '';
  
  const avail = game.familiars.filter(f => f.currentHp > 0);
  if (avail.length === 0) {
    grid.innerHTML = '<p>All familiars need healing!</p>';
    return;
  }
  
  avail.forEach(f => {
    const card = document.createElement('div');
    card.className = 'card';
    const img = f.image ? `<img src="${f.image}" style="width:80px;height:80px;border-radius:50%;" onerror="this.src='img/familiars/familiars.png'">` : '';
    card.innerHTML = `
      <div class="card-image">${img}</div>
      <h3>${f.name}</h3>
      <p>HP: ${f.currentHp}/${f.maxHp}</p>
      <button class="btn" onclick="startBattle(${f.id})">Choose</button>
    `;
    grid.appendChild(card);
  });
}

function startBattle(id) {
  const player = game.familiars.find(f => f.id === id);
  if (!player) return;
  
  let enemyPool = enemies;
  if (currentEvent && currentEvent.effect === 'rare_enemies') {
    enemyPool = enemies.filter(e => e.level >= 6);
  }
  
  const enemy = {...enemyPool[Math.floor(Math.random() * enemyPool.length)]};
  enemy.currentHp = enemy.hp;
  
  battle = { player: {...player}, enemy: enemy, turn: 'player' };
  
  document.getElementById('familiarSelect').style.display = 'none';
  document.getElementById('battleScreen').style.display = 'block';
  document.getElementById('battleLog').innerHTML = '';
  
  renderBattle();
  logBattle('A wild ' + enemy.name + ' appeared!');
}

function renderBattle() {
  const p = battle.player;
  const e = battle.enemy;
  
  const pPercent = (p.currentHp / p.maxHp) * 100;
  const ePercent = (e.currentHp / e.hp) * 100;
  
  const pImg = p.image ? `<img src="${p.image}" style="width:150px;height:150px;border-radius:50%;" onerror="this.src='img/familiars/familiars.png'">` : `<div style="width:150px;height:150px;background:#4a2e5a;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3em;">${p.species[0].toUpperCase()}</div>`;
  const eImg = e.image ? `<img src="${e.image}" style="width:150px;height:150px;border-radius:50%;" onerror="this.src='img/enemies/goblin.png'">` : `<div style="width:150px;height:150px;background:#5a2e2e;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3em;">üëπ</div>`;
  
  document.getElementById('playerFam').innerHTML = `
    <h3>${p.name}</h3>
    ${pImg}
    <p>HP: ${Math.max(0,p.currentHp)}/${p.maxHp}</p>
    <div class="health-bar"><div class="health-bar-fill" style="width:${pPercent}%"></div></div>
  `;
  
  document.getElementById('enemyFam').innerHTML = `
    <h3>${e.name}</h3>
    ${eImg}
    <p>HP: ${Math.max(0,e.currentHp)}/${e.hp}</p>
    <div class="health-bar"><div class="health-bar-fill" style="width:${ePercent}%"></div></div>
  `;
}

function doAttack() {
  if (battle.turn !== 'player') return;
  
  const p = battle.player;
  const e = battle.enemy;
  
  let dmg = Math.max(1, p.attack - e.defense);
  if (p.personality === 'Brave') dmg = Math.floor(dmg * 1.1);
  
  e.currentHp -= dmg;
  logBattle(p.name + ' attacks for ' + dmg + ' damage!');
  
  const el = document.getElementById('enemyFam');
  el.classList.add('hit', 'shake');
  setTimeout(() => el.classList.remove('hit', 'shake'), 500);
  
  renderBattle();
  
  if (e.currentHp <= 0) { endBattle('win'); return; }
  
  battle.turn = 'enemy';
  setTimeout(enemyTurn, 1000);
}

function doDefend() {
  if (battle.turn !== 'player') return;
  battle.player.defending = true;
  logBattle(battle.player.name + ' defends!');
  battle.turn = 'enemy';
  setTimeout(enemyTurn, 1000);
}

function doRetreat() {
  endBattle('retreat');
}

function enemyTurn() {
  const p = battle.player;
  const e = battle.enemy;
  
  let dmg = Math.max(1, e.attack - p.defense);
  if (p.defending) {
    dmg = Math.max(1, Math.floor(dmg * 0.5));
    p.defending = false;
  }
  
  p.currentHp -= dmg;
  logBattle(e.name + ' attacks for ' + dmg + ' damage!');
  
  const el = document.getElementById('playerFam');
  el.classList.add('hit', 'shake');
  setTimeout(() => el.classList.remove('hit', 'shake'), 500);
  
  renderBattle();
  
  if (p.currentHp <= 0) { endBattle('lose'); return; }
  
  battle.turn = 'player';
}

function endBattle(result) {
  if (result === 'win') {
    logBattle('Victory!');
    
    game.wins++;
    const xp = battle.enemy.level * 5;
    if (game.player.class === 'Wizard') {
      gainXP(Math.floor(xp * 1.5));
    } else {
      gainXP(xp);
    }
    
    const fam = game.familiars.find(f => f.id === battle.player.id);
    if (fam) {
      fam.currentHp = Math.max(1, battle.player.currentHp);
      fam.xp += xp;
      if (fam.xp >= 100) {
        fam.level++;
        fam.xp -= 100;
        fam.maxHp += 10;
        fam.currentHp = fam.maxHp;
        fam.attack += 2;
        fam.defense += 2;
        notify(fam.name + ' leveled up!');
        
        if (fam.level > game.highestFamiliarLevel) {
          game.highestFamiliarLevel = fam.level;
        }
        
        checkEvolution(fam);
      }
    }
    
    generateLoot();
    checkAchievements();
    
  } else if (result === 'lose') {
    logBattle('Defeat...');
    const fam = game.familiars.find(f => f.id === battle.player.id);
    if (fam) fam.currentHp = 0;
    notify('Your familiar fainted!');
  }
  
  save();
  updateUI();
  
  setTimeout(() => {
    document.getElementById('battleScreen').style.display = 'none';
    document.getElementById('familiarSelect').style.display = 'block';
    renderBattleSelect();
  }, 2000);
}

function generateLoot() {
  const drops = [];
  loot.forEach(entry => {
    let chance = entry.chance;
    if (currentEvent && currentEvent.effect === 'double_drops') chance *= 2;
    
    if (Math.random() < chance) {
      const qty = entry.qty[0] + Math.floor(Math.random() * (entry.qty[1] - entry.qty[0] + 1));
      addMaterial(entry.item, qty);
      drops.push({item: entry.item, qty: qty});
    }
  });
  
  const coins = 10 + Math.floor(Math.random() * 20);
  game.coins += coins;
  drops.push({item: 'Coins', qty: coins});
  
  showLootPopup(drops);
}

function showLootPopup(drops) {
  const popup = document.getElementById('lootPopup');
  const list = document.getElementById('lootList');
  list.innerHTML = '';
  drops.forEach(d => {
    const div = document.createElement('div');
    div.className = 'loot-item';
    div.textContent = d.item + ' x' + d.qty;
    list.appendChild(div);
  });
  popup.classList.remove('hidden');
}

function closeLoot() {
  document.getElementById('lootPopup').classList.add('hidden');
  updateUI();
  renderInventory();
}

function logBattle(msg) {
  const log = document.getElementById('battleLog');
  if (!log) return;
  const p = document.createElement('div');
  p.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
  log.appendChild(p);
  log.scrollTop = log.scrollHeight;
}

function addMaterial(name, qty) {
  if (!game.inventory[name]) game.inventory[name] = 0;
  game.inventory[name] += qty;
  game.totalMaterialsCollected += qty;
}

function renderInventory() {
  const grid = document.getElementById('inventoryGrid');
  grid.innerHTML = '';
  
  const items = Object.keys(game.inventory);
  if (items.length === 0) {
    grid.innerHTML = '<p>No materials. Battle to collect!</p>';
    return;
  }
  
  items.forEach(item => {
    const qty = game.inventory[item];
    if (qty <= 0) return;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<div class="card-image">üì¶</div><h3>${item}</h3><p>Qty: ${qty}</p>`;
    grid.appendChild(card);
  });
}

function renderCrafting() {
  const grid = document.getElementById('craftingGrid');
  grid.innerHTML = '';
  
  recipes.forEach(r => {
    const canCraft = Object.keys(r.mats).every(m => (game.inventory[m] || 0) >= r.mats[m]);
    const matsText = Object.entries(r.mats).map(([m,q]) => {
      const have = game.inventory[m] || 0;
      const color = have >= q ? '#2ecc71' : '#e74c3c';
      return `<span style="color:${color}">${m}: ${have}/${q}</span>`;
    }).join('<br>');
    
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${r.name}</h3>
      <p style="font-size:0.85em;margin:10px 0;">${matsText}</p>
      <button class="btn" ${!canCraft ? 'disabled' : ''} onclick="craft('${r.id}')">Craft</button>
    `;
    grid.appendChild(card);
  });
}

function craft(id) {
  const recipe = recipes.find(r => r.id === id);
  if (!recipe) return;
  
  const canCraft = Object.keys(recipe.mats).every(m => (game.inventory[m] || 0) >= recipe.mats[m]);
  if (!canCraft) { notify('Not enough materials!'); return; }
  
  Object.entries(recipe.mats).forEach(([m,q]) => {
    game.inventory[m] -= q;
  });
  
  if (recipe.type === 'familiar') {
    const newFam = {
      id: Date.now(),
      name: 'Summoned Beast',
      species: 'summoned',
      hp: 80,
      maxHp: 80,
      currentHp: 80,
      attack: 15,
      defense: 10,
      speed: 15,
      level: 1,
      xp: 0,
      rarity: 'rare',
      image: 'img/familiars/cat.png',
      personality: personalities[Math.floor(Math.random() * personalities.length)]
    };
    game.familiars.push(newFam);
    notify('Summoned a new familiar!');
  } else {
    game.familiars.forEach(f => {
      if (recipe.bonus.stat === 'defense') f.defense += recipe.bonus.val;
      if (recipe.bonus.stat === 'attack') f.attack += recipe.bonus.val;
    });
    notify('Crafted ' + recipe.name + '!');
  }
  
  checkAchievements();
  renderCrafting();
  renderInventory();
  renderFamiliars();
  save();
}

function renderShop() {
  const grid = document.getElementById('shopGrid');
  
  const items = [
    {name: 'Health Potion', price: 20, currency: 'coins', effect: 'heal'},
    {name: 'Iron Ore', price: 3, currency: 'dust', effect: 'material', mat: 'Iron Ore'},
    {name: 'Magic Dust', price: 5, currency: 'dust', effect: 'material', mat: 'Magic Dust'},
    {name: 'Rare Gem', price: 10, currency: 'dust', effect: 'material', mat: 'Rare Gem'}
  ];
  
  grid.innerHTML = '';
  items.forEach(item => {
    let price = item.price;
    if (currentEvent && currentEvent.effect === 'shop_sale') price = Math.floor(price * 0.5);
    
    const canBuy = game[item.currency] >= price;
    const card = document.createElement('div');
    card.className = 'card';
    const saleTag = (currentEvent && currentEvent.effect === 'shop_sale') ? '<p style="color:#2ecc71;">50% OFF!</p>' : '';
    card.innerHTML = `
      <div class="card-image">üõí</div>
      <h3>${item.name}</h3>
      ${saleTag}
      <p>Price: ${price} ${item.currency}</p>
      <button class="btn" ${!canBuy ? 'disabled' : ''} onclick='buyItem(${JSON.stringify({...item, price: price})})'>Buy</button>
    `;
    grid.appendChild(card);
  });
}

function buyItem(item) {
  if (game[item.currency] < item.price) { notify('Not enough ' + item.currency + '!'); return; }
  
  game[item.currency] -= item.price;
  
  if (item.effect === 'heal') {
    game.familiars.forEach(f => f.currentHp = f.maxHp);
    notify('All familiars healed!');
  } else if (item.effect === 'material') {
    addMaterial(item.mat, 1);
    notify('Purchased ' + item.name + '!');
  }
  
  updateUI();
  renderShop();
  renderInventory();
  save();
}

function gainXP(amount) {
  game.xp += amount;
  if (game.xp >= 100) {
    game.level++;
    game.xp -= 100;
    game.coins += game.level * 10;
    notify('Level up! Now level ' + game.level);
    checkAchievements();
  }
  updateUI();
  save();
}

function claimDaily() {
  const today = new Date().toDateString();
  if (game.lastDaily === today) { notify('Already claimed today!'); return; }
  game.coins += 50;
  game.dust += 5;
  game.lastDaily = today;
  notify('Daily claimed! +50 coins, +5 dust');
  updateUI();
  save();
}

function updateUI() {
  document.getElementById('coinCount').textContent = game.coins;
  document.getElementById('dustCount').textContent = game.dust;
  document.getElementById('playerLevel').textContent = game.level;
  document.getElementById('playerXP').textContent = game.xp;
  document.getElementById('playerClass').textContent = game.player.class || 'None';
  
  const stats = document.getElementById('journeyStats');
  if (stats) stats.innerHTML = 'Battles Won: ' + game.wins + '<br>Familiars: ' + game.familiars.length + '<br>Highest Level: ' + game.highestFamiliarLevel;
  
  const msg = document.getElementById('welcomeMsg');
  if (msg && game.player.class) {
    msg.textContent = 'Welcome back, ' + game.player.class + ' of the ' + game.player.faction + '!';
  }
}

function notify(msg) {
  const n = document.getElementById('notif');
  if (!n) return;
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3000);
}

function save() {
  try {
    localStorage.setItem('fabledFamiliars', JSON.stringify(game));
  } catch(e) {
    console.warn('Save failed', e);
  }
}

function load() {
  const saved = localStorage.getItem('fabledFamiliars');
  if (saved) {
    try {
      Object.assign(game, JSON.parse(saved));
    } catch(e) {
      console.warn('Load failed', e);
    }
  }
}

function clearSave() {
  if (confirm('Delete all progress?')) {
    localStorage.removeItem('fabledFamiliars');
    location.reload();
  }
}

function init() {
  load();
  if (game.init) {
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('statusBar').style.display = 'flex';
    updateAvatar();
    goToSection('home');
    renderFamiliars();
    setInterval(triggerRandomEvent, 120000);
  } else {
    renderStarters();
  }
  updateUI();
  setInterval(() => {
    document.getElementById('serverTime').textContent = new Date().toLocaleTimeString();
  }, 1000);
}

document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>